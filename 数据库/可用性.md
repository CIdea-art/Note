## 数据迁移

分库分表后还有个让人头疼的问题，那就是数据迁移，为了不影响现有的业务系统，通常会新建数据库集群迁移数据。将数据从旧集群的数据库、表迁移到新集群的分库、分表中。这是一个比较复杂的过程，在迁移过程中需要考虑`数据量`、`数据一致性`、`迁移速度`等诸多因素。

迁移主要针对 `存量数据` 和 `增量数据` 的处理，存量数据指旧数据源中已经存在且有价值的历史数据，增量数据指当下持续增长以及未来产生的业务数据。

存量数据可以采用定时、分批次的迁移，迁移过程可能会持续几天。

增量数据可以采用新、旧数据库集群双写模式。待数据迁移完毕，业务验证了数据一致性，应用直接切换数据源即可。

**水平扩容库（升级从库法）**

**水平扩容表（双写迁移法）**

## 影子库

影子库是一个与生产环境数据库结构完全相同的实例，它存在的意义是为了在不影响线上系统的情况下，验证数据库迁移或者其他数据库变更操作的正确性，以及全链路压测。影子库中存储的数据是从生产环境中定期复制过来的，但是它不对线上业务产生任何影响，仅用于测试，验证和调试。

在进行数据库升级、版本变更、参数调优等操作前，通过在影子库上模拟这些操作，可以发现潜在的问题，因为测试环境的数据是不可靠的。

在使用影子库时，需要遵循以下几个原则：

- 与生产环境数据库的结构应该完全一致，包括表结构、索引、约束等；
- 数据要与生产环境保持一致，可以通过定期同步方式实现；
- 读写操作不会影响生产环境，一般情况下应该禁止在影子库上执行更新、删除等操作；
- 由于影子库的数据特点，访问权限应该严格控制，只允许授权人员进行访问和操作；

# 参考

文献

https://mp.weixin.qq.com/s/HRIaCTvDnfxR3G3zWmEvUw