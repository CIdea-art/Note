涉及因素很多，有网络、服务器硬件、操作系统、后端服务、程序自身、数据库服务等，只列关于Ng几个高收益的

### 长连接

减少握手的次数，降低服务器损耗

```
upstream xxx {  
    # 长连接数  
    keepalive 32;  
    # 每个长连接提供的最大请求数  
    keepalived_requests 100;  
    # 每个长连接没有新的请求时，保持的最长时间  
    keepalive_timeout 60s;  
}  
```

### 零拷贝

零拷贝读取机制与传统资源读取机制的区别：

- **「传统方式：」** 硬件-->内核-->用户空间-->程序空间-->程序内核空间-->网络套接字
- **「零拷贝方式：」** 硬件-->内核-->程序内核空间-->网络套接字

```
sendfile on; # 开启零拷贝机制  
```

### 无延迟或多包共发机制

`TCP/IP`协议中默认是采用了Nagle算法的，即在网络数据传输过程中，每个数据报文并不会立马发送出去，而是会等待一段时间，将后面的几个数据包一起组合成一个数据报文发送，但这个算法虽然提高了网络吞吐量，但是实时性却降低了。

在`Nginx`中有两个较为关键的性能参数，即`tcp_nodelay、tcp_nopush`，开启方式如下：

```
tcp_nodelay on;  
tcp_nopush on;  
```

如果项目属于交互性很强的应用，那么可以手动开启`tcp_nodelay`配置，让应用程序向内核递交的每个数据包都会立即发送出去。但这样会产生大量的`TCP`报文头，增加很大的网络开销。

相反，有些项目的业务对数据的实时性要求并不高，追求的则是更高的吞吐，那么则可以开启`tcp_nopush`配置项，这个配置就类似于“塞子”的意思，首先将连接塞住，使得数据先不发出去，等到拔去塞子后再发出去。设置该选项后，内核会尽量把小数据包拼接成一个大的数据包（一个`MTU`）再发送出去.

> 当然若一定时间后（一般为`200ms`），内核仍然没有积累到一个`MTU`的量时，也必须发送现有的数据，否则会一直阻塞。
>

`tcp_nodelay、tcp_nopush`两个参数是“互斥”的，如果追求响应速度的应用推荐开启`tcp_nodelay`参数，如`IM`、金融等类型的项目。如果追求吞吐量的应用则建议开启`tcp_nopush`参数，如调度系统、报表系统等。

> 注意：①`tcp_nodelay`一般要建立在开启了长连接模式的情况下使用。②`tcp_nopush`参数是必须要开启`sendfile`参数才可使用的。
>

### 调整Worker工作进程

`Nginx`启动后默认只会开启一个`Worker`工作进程处理客户端请求，而我们可以根据机器的CPU核数开启对应数量的工作进程，以此来提升整体的并发量支持，如下：

```
# 自动根据CPU核心数调整Worker进程数量  
worker_processes auto;  
```

> 工作进程的数量最高开到`8`个就OK了，`8`个之后就不会有再大的性能提升。
>

同时也可以稍微调整一下每个工作进程能够打开的文件句柄数：

```
# 每个Worker能打开的文件描述符，最少调整至1W以上，负荷较高建议2-3W
worker_rlimit_nofile 20000;  
```

> 操作系统内核（`kernel`）都是利用文件描述符来访问文件，无论是打开、新建、读取、写入文件时，都需要使用文件描述符来指定待操作的文件，因此该值越大，代表一个进程能够操作的文件越多（但不能超出内核限制，最多建议`3.8W`左右为上限）。
>

### 开启CPU亲和机制

对于并发编程较为熟悉的伙伴都知道，因为进程/线程数往往都会远超出系统CPU的核心数，因为操作系统执行的原理本质上是采用时间片切换机制，也就是一个CPU核心会在多个进程之间不断频繁切换，造成很大的性能损耗。

而CPU亲和机制则是指将每个`Nginx`的工作进程，绑定在固定的CPU核心上，从而减小CPU切换带来的时间开销和资源损耗，开启方式如下：

```
worker_cpu_affinity auto;  
```

### 开启epoll模型及调整并发连接数

在最开始就提到过：`Nginx、Redis`都是基于多路复用模型去实现的程序，但最初版的多路复用模型`select/poll`最大只能监听`1024`个连接，而`epoll`则属于`select/poll`接口的增强版，因此采用该模型能够大程度上提升单个`Worker`的性能，如下：

```
events {  
    # 使用epoll网络模型  
    use epoll;  
    # 调整每个Worker能够处理的连接数上限  
    worker_connections  10240;  
}  
```

> TODO：`select/poll/epoll`模型